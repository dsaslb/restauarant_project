{% extends "base.html" %}

{% block title %}관리자 대시보드{% endblock %}

{% block content %}
<h2>관리자/팀장 대시보드</h2>
<div class="row mb-3">
  <div class="col-md-3">
    <div class="card text-bg-light mb-3">
      <div class="card-body">
        <b>직원 수:</b> {{total_staff}}<br>
        <b>오늘 출근:</b> {{today_att}}명
        <span style="color:red;">(지각: {{late_cnt}} / 결근: {{abs_cnt}})</span><br>
        <b>미처리 신고/이의:</b> <span style="color:orange;">{{pending_reports}}</span><br>
        <b>경고 직원 수:</b> <span style="color:red;">{{warning_users}}</span>
      </div>
    </div>
  </div>
  <div class="col-md-5">
    <div class="card text-bg-light mb-3">
      <div class="card-body">
        <h5 class="card-title">최근 사유 TOP5</h5>
        <ul class="mb-0">
        {% for reason, cnt in top_reasons %}
          <li>{{ reason }} ({{ cnt }}회)</li>
        {% endfor %}
        </ul>
      </div>
    </div>
  </div>
  <div class="col-md-4 d-flex align-items-center">
    <div>
      <a href="{{ url_for('admin_excuse_list') }}" class="btn btn-warning mb-2">신고/이의 처리 바로가기</a>
      <a href="{{ url_for('attendance_stats') }}" class="btn btn-info mb-2">출결 통계 차트</a>
    </div>
  </div>
</div>

<!-- 기간 필터 -->
<form class="row g-3 mb-3">
  <div class="col-auto">
    <input type="date" class="form-control" name="from" value="{{ request.args.get('from','') }}">
  </div>
  <div class="col-auto">
    <input type="date" class="form-control" name="to" value="{{ request.args.get('to','') }}">
  </div>
  <div class="col-auto">
    <button type="submit" class="btn btn-secondary">기간검색</button>
  </div>
</form>

<!-- 팀/직원별 필터링 폼 -->
<form method="get" class="row g-3 mb-3">
  <div class="col-md-2">
    <select name="team" class="form-select">
      <option value="">전체팀</option>
      {% for t in all_teams %}
      <option value="{{t}}" {% if request.args.get('team')==t %}selected{% endif %}>{{t}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <select name="user_id" class="form-select">
      <option value="">전체직원</option>
      {% for u in users %}
      <option value="{{u.id}}" {% if request.args.get('user_id')==u.id|string %}selected{% endif %}>{{u.name or u.username}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <input type="date" name="from" class="form-control" value="{{request.args.get('from') or ''}}">
  </div>
  <div class="col-md-2">
    <input type="date" name="to" class="form-control" value="{{request.args.get('to') or ''}}">
  </div>
  <div class="col-md-3">
    <button type="submit" class="btn btn-primary">필터</button>
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">초기화</a>
  </div>
</form>

<!-- 내보내기 버튼 -->
<div class="row mb-3">
  <div class="col-12">
    <div class="btn-group" role="group">
      <a href="{{ url_for('export_admin_dashboard_excel', **request.args) }}" class="btn btn-success">
        <i class="fas fa-file-excel"></i> 엑셀 다운로드
      </a>
      <a href="{{ url_for('export_admin_dashboard_pdf', **request.args) }}" class="btn btn-danger">
        <i class="fas fa-file-pdf"></i> PDF 다운로드
      </a>
    </div>
  </div>
</div>

<!-- 빠른 링크 -->
<div class="row mb-3">
  <div class="col-12">
    <div class="btn-group" role="group">
      <a href="{{ url_for('admin_statistics') }}" class="btn btn-primary">
        <i class="fas fa-chart-bar"></i> 월별 통계
      </a>
      <a href="{{ url_for('admin_attendance_reason_stats') }}" class="btn btn-warning">
        <i class="fas fa-chart-pie"></i> 사유별 통계
      </a>
      <a href="{{ url_for('admin_users') }}" class="btn btn-info">
        <i class="fas fa-users"></i> 직원 관리
      </a>
      <a href="{{ url_for('admin_swap_requests') }}" class="btn btn-warning">
        <i class="fas fa-exchange-alt"></i> 근무 변경 신청
      </a>
      <a href="{{ url_for('admin_reports') }}" class="btn btn-success">
        <i class="fas fa-file-alt"></i> 보고서 관리
      </a>
      <a href="{{ url_for('admin_all_notifications') }}" class="btn btn-info">
        <i class="fas fa-bell"></i> 알림센터
      </a>
      <a href="{{ url_for('admin_all_notifications') }}" class="btn btn-primary">
        <i class="fas fa-bell"></i> 전체 알림 관리
      </a>
      <a href="{{ url_for('admin_notification_stats') }}" class="btn btn-success">
        <i class="fas fa-chart-pie"></i> 알림 통계
      </a>
    </div>
  </div>
</div>

<!-- 새로운 관리 기능 메뉴 -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-tools"></i> 업무 관리</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-primary w-100">
              <i class="fas fa-users"></i> 직원 관리
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-success w-100">
              <i class="fas fa-calendar-alt"></i> 스케줄 관리
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-warning w-100">
              <i class="fas fa-shopping-cart"></i> 발주 관리
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-info w-100">
              <i class="fas fa-broom"></i> 청소 관리
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 새로운 기능 버튼들 -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-cogs"></i> 자동화 기능</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-primary w-100">
              <i class="fas fa-file-pdf"></i> 월별 근태 요약 PDF
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-success w-100" 
               onclick="return confirm('일괄 급여 이체를 실행하시겠습니까?')">
              <i class="fas fa-money-bill-wave"></i> 급여 자동이체
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-info w-100">
              <i class="fas fa-bell"></i> 알림 발송
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="#" class="btn btn-outline-secondary w-100">
              <i class="fas fa-download"></i> DB 백업
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 백업/복원 기능 -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-database"></i> 데이터 관리</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_backup') }}" class="btn btn-outline-primary w-100">
              <i class="fas fa-download"></i> DB 백업
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_restore') }}" class="btn btn-outline-warning w-100">
              <i class="fas fa-upload"></i> DB 복원
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_file_backup') }}" class="btn btn-outline-info w-100">
              <i class="fas fa-folder-open"></i> 파일 백업
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('admin_file_restore') }}" class="btn btn-outline-secondary w-100">
              <i class="fas fa-folder-plus"></i> 파일 복원
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 출결 통계 차트 섹션 -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 출결 통계 차트</h5>
        <div class="mt-2">
          <button onclick="exportChart()" class="btn btn-sm btn-success">
            <i class="fas fa-download"></i> 차트 이미지 저장
          </button>
          <button onclick="refreshChart()" class="btn btn-sm btn-primary">
            <i class="fas fa-sync"></i> 새로고침
          </button>
        </div>
      </div>
      <div class="card-body">
        <canvas id="attendanceChart" width="700" height="220"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- 팀별 통계 차트 -->
<div class="row mb-3">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> 팀별 출결 통계</h5>
      </div>
      <div class="card-body">
        <canvas id="teamChart" width="400" height="200"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-doughnut"></i> 사유별 통계</h5>
      </div>
      <div class="card-body">
        <canvas id="reasonChart" width="400" height="200"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-bg-light mb-3">
      <div class="card-body">
        <h5 class="card-title">직원수</h5>
        <p class="card-text fs-2">{{ num_users }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-bg-light mb-3">
      <div class="card-body">
        <h5 class="card-title">누적 출근기록</h5>
        <p class="card-text fs-2">{{ num_attendance }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    {% if warn_users %}
      <div class="alert alert-warning">
        <b>경고!</b> {{ warn_users|join(', ') }} : 이번 달 지각 2회 이상/결근 발생
      </div>
    {% endif %}
  </div>
</div>

<!-- 월별 변화 추이 차트 -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> 월별 변화 추이</h5>
      </div>
      <div class="card-body">
        <canvas id="monthlyStatsChart" width="750" height="320"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- 알림 카테고리별 통계 -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-chart-pie"></i> 알림 카테고리별 통계</h5>
      </div>
      <div class="card-body">
        <canvas id="categoryPieChart" width="400" height="250"></canvas>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> 통계 요약</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-primary">{{ noti_stats|length }}</h4>
              <small class="text-muted">월별 알림 통계</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-success">{{ noti_category_stats|length }}</h4>
              <small class="text-muted">알림 카테고리</small>
            </div>
          </div>
        </div>
        <hr>
        <div class="row">
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-info">{{ work_stats|length }}</h4>
              <small class="text-muted">근무 스케줄 월</small>
            </div>
          </div>
          <div class="col-6">
            <div class="text-center">
              <h4 class="text-warning">{{ clean_stats|length }}</h4>
              <small class="text-muted">청소 계획 월</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- 지점별 비교 -->
<h5>지점별 근무시간/지각/결근 비교</h5>
<table class="table">
  <thead><tr><th>지점</th><th>직원수</th><th>총 근무(분)</th><th>지각</th><th>결근</th></tr></thead>
  <tbody>
    {% for r in result %}
    <tr>
      <td>{{ r.branch }}</td>
      <td>{{ r.user_count }}</td>
      <td>{{ r.total_work }}</td>
      <td>{{ r.total_late }}</td>
      <td>{{ r.total_absent }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<canvas id="branchChart"></canvas>

<div class="row">
  <div class="col-md-6">
    <h5>월별 직원 근무시간 합계</h5>
    <canvas id="barChart"></canvas>
  </div>
  <div class="col-md-6">
    <h5>일자별 근무시간(분) 트렌드</h5>
    <canvas id="lineChart"></canvas>
  </div>
</div>
<div class="row mt-4">
  <div class="col-md-6">
    <h5>근무시간 분포</h5>
    <canvas id="pieChart"></canvas>
  </div>
  <div class="col-md-6">
    <h5>이번달 지각 랭킹</h5>
    <ol>
      {% for r in top_late %}
      <li>{{ r.user }} ({{ r.late_count }}회)</li>
      {% endfor %}
    </ol>
    <h5>이번달 결근 랭킹</h5>
    <ol>
      {% for r in top_absent %}
      <li>{{ r.user }} ({{ r.absent_count }}회)</li>
      {% endfor %}
    </ol>
  </div>
</div>

<h5 class="mt-4">최근 출퇴근 이력(10건)</h5>
<table class="table table-bordered">
  <thead>
    <tr><th>직원</th><th>출근</th><th>퇴근</th><th>근무(분)</th><th>상태</th></tr>
  </thead>
  <tbody>
    {% for r in recent %}
    <tr>
      <td>{{ r.user }}</td>
      <td>{{ r.clock_in }}</td>
      <td>{{ r.clock_out if r.clock_out else '미입력' }}</td>
      <td>{{ r.work_minutes }}</td>
      <td>{{ r.status }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 월별 변화 추이 차트
let monthlyLabels = [
  {% for stat in noti_stats %}'{{ stat.month }}',{% endfor %}
];
let notiData = [{% for stat in noti_stats %}{{ stat.count }},{% endfor %}];
let workData = [{% for stat in work_stats %}{{ stat.count }},{% endfor %}];
let orderData = [{% for stat in order_stats %}{{ stat.count }},{% endfor %}];
let cleanData = [{% for stat in clean_stats %}{{ stat.count }},{% endfor %}];

let monthlyCtx = document.getElementById('monthlyStatsChart').getContext('2d');
let monthlyChart = new Chart(monthlyCtx, {
  type: 'line',
  data: {
    labels: monthlyLabels,
    datasets: [
      { 
        label: '알림', 
        data: notiData, 
        borderColor: '#f0ad4e', 
        backgroundColor: 'rgba(240, 173, 78, 0.1)',
        fill: false,
        tension: 0.4
      },
      { 
        label: '근무', 
        data: workData, 
        borderColor: '#5bc0de', 
        backgroundColor: 'rgba(91, 192, 222, 0.1)',
        fill: false,
        tension: 0.4
      },
      { 
        label: '발주', 
        data: orderData, 
        borderColor: '#5cb85c', 
        backgroundColor: 'rgba(92, 184, 92, 0.1)',
        fill: false,
        tension: 0.4
      },
      { 
        label: '청소', 
        data: cleanData, 
        borderColor: '#d9534f', 
        backgroundColor: 'rgba(217, 83, 79, 0.1)',
        fill: false,
        tension: 0.4
      }
    ]
  },
  options: {
    responsive: true,
    plugins: { 
      legend: { position: 'top' },
      title: {
        display: true,
        text: '월별 업무 현황 변화'
      }
    },
    scales: { 
      y: { 
        beginAtZero: true,
        title: {
          display: true,
          text: '건수'
        }
      },
      x: {
        title: {
          display: true,
          text: '월'
        }
      }
    }
  }
});

// 알림 카테고리별 파이 차트
let categories = [{% for stat in noti_category_stats %}'{{ stat.category }}',{% endfor %}];
let categoryCounts = [{% for stat in noti_category_stats %}{{ stat.count }},{% endfor %}];

let pieCtx = document.getElementById('categoryPieChart').getContext('2d');
let pieChart = new Chart(pieCtx, {
  type: 'pie',
  data: {
    labels: categories,
    datasets: [{ 
      data: categoryCounts,
      backgroundColor: [
        '#f0ad4e',
        '#5bc0de', 
        '#5cb85c',
        '#d9534f',
        '#337ab7',
        '#777777'
      ]
    }]
  },
  options: {
    responsive: true,
    plugins: { 
      legend: { position: 'bottom' },
      title: {
        display: true,
        text: '알림 카테고리 분포'
      }
    }
  }
});

// 기존 차트들
// 지점별 차트
new Chart(document.getElementById('branchChart'), {
  type: 'bar',
  data: {
    labels: {{ branch_names|tojson }},
    datasets: [{
      label: '지점별 근무시간(분)',
      data: {{ result|map(attribute='total_work')|list|tojson }},
      backgroundColor: 'rgba(54, 162, 235, 0.5)'
    }]
  }
});

new Chart(document.getElementById('barChart'), {
  type: 'bar',
  data: {
    labels: {{ chart_labels|tojson }},
    datasets: [{ label: '근무시간(분)', data: {{ chart_data|tojson }}, borderWidth: 1 }]
  }, options: {scales: { y: { beginAtZero: true } } }
});
new Chart(document.getElementById('lineChart'), {
  type: 'line',
  data: {
    labels: {{ trend_dates|tojson }},
    datasets: [{ label: '근무시간(분)', data: {{ trend_data|tojson }}, borderWidth: 1, tension: 0.4 }]
  }
});
new Chart(document.getElementById('pieChart'), {
  type: 'pie',
  data: {
    labels: {{ dist_labels|tojson }},
    datasets: [{ data: {{ dist_data|tojson }} }]
  }
});

// 출결 통계 차트
let attendanceChart = null;

function loadAttendanceChart() {
  // 임시 데이터 (실제로는 API 호출)
  const mockData = {
    labels: ['01-01', '01-02', '01-03', '01-04', '01-05', '01-06', '01-07'],
    late: [2, 1, 3, 0, 1, 2, 1],
    absent: [0, 1, 0, 1, 0, 0, 1],
    total: [15, 14, 15, 14, 15, 15, 14]
  };
  
  if (attendanceChart) attendanceChart.destroy();
  
  const ctx = document.getElementById('attendanceChart');
  if (ctx) {
    attendanceChart = new Chart(ctx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: mockData.labels,
        datasets: [
          {label: '지각', data: mockData.late, backgroundColor: '#ffe082'},
          {label: '결근', data: mockData.absent, backgroundColor: '#ef9a9a'},
          {label: '전체', data: mockData.total, backgroundColor: '#90caf9', type: 'line', order: 0}
        ]
      },
      options: {responsive: true, scales: {y: {beginAtZero: true}}}
    });
  }
}

function exportChart() {
  if (attendanceChart) {
    const url = attendanceChart.toBase64Image();
    const a = document.createElement('a');
    a.href = url; a.download = 'attendance_chart.png'; a.click();
  }
}

function refreshChart() {
  loadAttendanceChart();
}

// 팀별 차트
function loadTeamChart() {
  const mockTeamData = {
    labels: ['팀A', '팀B', '팀C', '미지정'],
    total: [25, 30, 20, 5]
  };
  
  const ctx = document.getElementById('teamChart');
  if (ctx) {
    new Chart(ctx.getContext('2d'), {
      type: 'pie',
      data: {
        labels: mockTeamData.labels,
        datasets: [{
          data: mockTeamData.total,
          backgroundColor: ['#ff6384', '#36a2eb', '#cc65fe', '#ffce56']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {display: true, text: '팀별 출결 현황'},
          legend: {position: 'bottom'}
        }
      }
    });
  }
}

// 사유별 차트
function loadReasonChart() {
  const mockReasonData = {
    labels: ['정상출근', '지각', '결근', '병가', '기타'],
    data: [120, 15, 8, 5, 12]
  };
  
  const ctx = document.getElementById('reasonChart');
  if (ctx) {
    new Chart(ctx.getContext('2d'), {
      type: 'doughnut',
      data: {
        labels: mockReasonData.labels,
        datasets: [{
          data: mockReasonData.data,
          backgroundColor: ['#4bc0c0', '#ff6384', '#36a2eb', '#cc65fe', '#ffce56']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {display: true, text: '사유별 출결 분포'},
          legend: {position: 'bottom'}
        }
      }
    });
  }
}

// 페이지 로드 시 차트 초기화
document.addEventListener('DOMContentLoaded', function() {
  loadAttendanceChart();
  loadTeamChart();
  loadReasonChart();
});

// 필터 폼 제출 시 차트 새로고침
document.querySelectorAll('form').forEach(form => {
  form.addEventListener('submit', function() {
    setTimeout(() => {
      refreshChart();
    }, 100);
  });
});
</script>
{% endblock %} 